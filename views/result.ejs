<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .score-card {
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4));
        }

        .big-score {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--color-primary);
            line-height: 1;
            margin: 10px 0;
        }

        .score-label {
            color: var(--color-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .rank-range {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-secondary);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .progress-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--color-success) var(--p, 0%), rgba(0, 0, 0, 0.1) 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            position: relative;
        }

        .progress-inner {
            width: 80%;
            height: 80%;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .candidate-info-bar {
            background: white;
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            border-top: 4px solid var(--color-primary);
        }

        .info-item label {
            display: block;
            font-size: 0.8rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-item span {
            font-weight: 700;
            color: var(--color-secondary);
            font-size: 1rem;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analytic-card {
            background: rgba(var(--color-primary-rgb), 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(var(--color-primary-rgb), 0.1);
            text-align: center;
        }

        .analytic-val {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--color-primary);
            margin: 5px 0;
        }

        .analytic-sub {
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        .percentile-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            background: var(--color-primary);
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
            margin-top: 10px;
        }

        @media print {
            .main-wrapper>*:not(.container) {
                display: none;
            }

            .download-actions,
            .btn-secondary {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="main-wrapper">
        <%- include('partials/header') %>

            <div class="container" id="scorecard">
                <div class="result-header" style="text-align: center; margin-bottom: 20px;">
                    <h2 style="margin-bottom: 5px;">Scorecard: RankSaarthi</h2>
                    <p style="color: var(--color-primary); font-weight: 600;">
                        <%= exam.name %>
                    </p>
                </div>

                <% if (results.candidateInfo) { %>
                    <div class="candidate-info-bar">
                        <div class="info-item"><label>Roll Number</label><span>
                                <%= results.candidateInfo.rollNo %>
                            </span></div>
                        <div class="info-item"><label>Candidate Name</label><span>
                                <%= results.candidateInfo.name %>
                            </span></div>
                        <div class="info-item"><label>Exam Date</label><span>
                                <%= results.candidateInfo.date %>
                            </span></div>
                        <div class="info-item"><label>Exam Shift</label><span>
                                <%= results.candidateInfo.time %>
                            </span></div>
                        <div class="info-item"><label>Details</label><span>
                                <%= inputs.category %>
                                    <%= inputs.horizontal_category !=='None' ? '(' +inputs.horizontal_category+')' : ''
                                        %> Â· <%= inputs.state %>
                                            <%= inputs.zone ? ' Â· Zone: ' + inputs.zone : '' %>
                            </span></div>
                    </div>
                    <% } %>

                        <!-- Real-time Comparison Analytics -->
                        <div class="glass-card" style="margin-bottom: 30px;">
                            <h3 style="margin-bottom: 20px; color: var(--color-primary);">
                                <%= exam.category==='Railway' ? 'ðŸš‚ Railway Real-time Analysis'
                                    : 'ðŸ“Š Real-time Comparison' %> (Among participants)
                            </h3>
                            <div class="analytics-grid">
                                <div class="analytic-card">
                                    <div class="score-label">Overall Rank</div>
                                    <div class="analytic-val">
                                        <%= results.analytics.overall.rank %> / <%= results.analytics.overall.total %>
                                    </div>
                                    <div class="analytic-sub">Out of all participants</div>
                                    <div class="percentile-tag">
                                        <%= results.analytics.overall.percentile %>%ile
                                    </div>
                                </div>
                                <div class="analytic-card">
                                    <div class="score-label">Category Rank</div>
                                    <div class="analytic-val">
                                        <%= results.analytics.category.rank %> / <%= results.analytics.category.total %>
                                    </div>
                                    <div class="analytic-sub">In <%= inputs.category %> category</div>
                                    <div class="percentile-tag">
                                        <%= results.analytics.category.percentile %>%ile
                                    </div>
                                </div>
                                <% if (inputs.zone) { %>
                                    <div class="analytic-card">
                                        <div class="score-label">Zone Rank</div>
                                        <div class="analytic-val">
                                            <%= results.analytics.zone.rank %> / <%= results.analytics.zone.total %>
                                        </div>
                                        <div class="analytic-sub">In RRB <%= inputs.zone %>
                                        </div>
                                        <div class="percentile-tag">
                                            <%= results.analytics.zone.percentile %>%ile
                                        </div>
                                    </div>

                                    <% if (inputs.category) { %>
                                        <div class="analytic-card">
                                            <div class="score-label">Category Rank in Zone</div>
                                            <div class="analytic-val">
                                                <%= results.analytics.categoryZone.rank %> / <%=
                                                        results.analytics.categoryZone.total %>
                                            </div>
                                            <div class="analytic-sub">
                                                <%= inputs.category %> in RRB <%= inputs.zone %>
                                            </div>
                                            <div class="percentile-tag">
                                                <%= results.analytics.categoryZone.percentile %>%ile
                                            </div>
                                        </div>
                                        <% } %>
                                            <% } %>
                                                <% if (results.candidateInfo && results.candidateInfo.date !=='N/A' ) {
                                                    %>
                                                    <div class="analytic-card">
                                                        <div class="score-label">Shift Rank</div>
                                                        <div class="analytic-val">
                                                            <%= results.analytics.shift.rank %> / <%=
                                                                    results.analytics.shift.total %>
                                                        </div>
                                                        <div class="analytic-sub">In Shift: <%=
                                                                results.candidateInfo.time %>
                                                        </div>
                                                        <div class="percentile-tag">
                                                            <%= results.analytics.shift.percentile %>%ile
                                                        </div>
                                                    </div>
                                                    <% } %>
                            </div>
                        </div>

                        <div class="dashboard-grid">
                            <div class="glass-card score-card">
                                <p class="score-label">Total Marks</p>
                                <div class="big-score">
                                    <%= results.totalScore %>
                                </div>
                                <p style="font-size: 0.9rem;">Out of <%= exam.total_questions * exam.marks_per_question
                                        %>
                                </p>
                            </div>

                            <div class="glass-card score-card">
                                <p class="score-label">Expected Rank (Global)</p>
                                <div class="rank-range" style="margin: 20px 0;">
                                    <%= results.prediction.min_rank %> - <%= results.prediction.max_rank %>
                                </div>
                                <div class="tag"
                                    style="background: <%= results.prediction.cutoff_probability === 'High' ? 'var(--color-success)' : (results.prediction.cutoff_probability === 'Medium' ? 'var(--color-warning)' : 'var(--color-error)') %>; color: white; padding: 5px 15px; border-radius: 20px;">
                                    Cutoff Chance: <%= results.prediction.cutoff_probability %>
                                </div>
                            </div>

                            <div class="glass-card score-card">
                                <p class="score-label">Accuracy</p>
                                <div style="margin-top: 20px;">
                                    <div class="progress-circle" style="--p: <%= results.accuracy %>%">
                                        <div class="progress-inner"><span class="percentage">
                                                <%= results.accuracy %>%
                                            </span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <% if (results.sections) { %>
                            <div class="glass-card" style="margin-top: 20px;">
                                <h3 style="margin-bottom: 15px; color: var(--color-primary);">Subject-wise Breakdown
                                </h3>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--color-primary);">
                                            <th style="padding: 10px; text-align: left;">Subject</th>
                                            <th style="padding: 10px;">Correct</th>
                                            <th style="padding: 10px;">Wrong</th>
                                            <th style="padding: 10px;">Marks</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% Object.keys(results.sections).forEach(s=> {
                                            const sec = results.sections[s];
                                            const sm = (sec.correct * exam.marks_per_question) - (sec.wrong *
                                            exam.negative_marks);
                                            %>
                                            <tr style="border-bottom: 1px solid #eee;">
                                                <td style="padding: 10px; text-align: left; font-weight: 600;">
                                                    <%= s %>
                                                </td>
                                                <td style="text-align: center;">
                                                    <%= sec.correct %>
                                                </td>
                                                <td style="text-align: center;">
                                                    <%= sec.wrong %>
                                                </td>
                                                <td style="text-align: center; font-weight: 700;">
                                                    <%= sm.toFixed(2) %>
                                                </td>
                                            </tr>
                                            <% }) %>
                                    </tbody>
                                </table>
                            </div>
                            <% } %>
            </div>

            <div class="download-actions">
                <button onclick="window.print()" class="btn btn-secondary">Download PDF</button>
                <button onclick="downloadImage()" class="btn btn-primary">Save as Image</button>
            </div>

            <div style="text-align: center; margin-bottom: 40px;">
                <a href="/" class="btn btn-secondary">Check Another Exam</a>
            </div>

            <%- include('partials/footer') %>
    </div>

    <script>
        async function downloadImage() {
            const element = document.getElementById('scorecard');
            const canvas = await html2canvas(element, { scale: 2, useCORS: true });
            const link = document.createElement('a');
            link.download = 'RankSaarthi-Scorecard.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }
    </script>
</body>

</html>